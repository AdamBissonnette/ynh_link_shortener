#!/bin/bash

source /usr/share/yunohost/helpers

#=================================================
# RETRIEVE ARGUMENTS
#=================================================

# Get the action (apply, show, etc.)
action=${1:-show}

#=================================================
# SPECIFIC GETTERS FOR TOML SHORT KEY
#=================================================

get__admin_password() {
    # Read current password from .env file
    local value=$(grep "^ADMIN_PASSWORD=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-}"
}

get__allowed_admin_ips() {
    local value=$(grep "^ALLOWED_ADMIN_IPS=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-*}"
}

get__admin_path() {
    local value=$(grep "^ADMIN_PATH=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-/derp}"
}

get__root_redirect() {
    local value=$(grep "^ROOT_REDIRECT=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-https://example.com}"
}

get__not_found_redirect() {
    local value=$(grep "^NOT_FOUND_REDIRECT=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-https://example.com}"
}

get__session_window_min() {
    local value=$(grep "^SESSION_WINDOW_MIN=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-30}"
}

get__user_cookie_max_days() {
    local value=$(grep "^USER_COOKIE_MAX_DAYS=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-730}"
}

get__cookie_secure() {
    local value=$(grep "^COOKIE_SECURE=" "$install_dir/.env" | cut -d'=' -f2-)
    value=${value:-true}
    if [ "$value" = "true" ]; then
        echo "1"
    else
        echo "0"
    fi
}

get__rate_limit_window() {
    local value=$(grep "^RATE_LIMIT_WINDOW=" "$install_dir/.env" | cut -d'=' -f2-)
    echo "${value:-60}"
}

#=================================================
# SPECIFIC VALIDATORS FOR TOML SHORT KEYS
#=================================================

validate__admin_password() {
    # Check password is not empty
    if [ -z "$admin_password" ]; then
        echo "Password cannot be empty"
        return 1
    fi
}

validate__session_window_min() {
    # Must be a positive number
    if ! [[ "$session_window_min" =~ ^[0-9]+$ ]] || [ "$session_window_min" -lt 1 ]; then
        echo "Session window must be a positive number"
        return 1
    fi
}

validate__user_cookie_max_days() {
    # Must be a positive number
    if ! [[ "$user_cookie_max_days" =~ ^[0-9]+$ ]] || [ "$user_cookie_max_days" -lt 1 ]; then
        echo "Cookie lifetime must be a positive number"
        return 1
    fi
}

validate__rate_limit_window() {
    # Must be a non-negative number
    if ! [[ "$rate_limit_window" =~ ^[0-9]+$ ]]; then
        echo "Rate limit window must be a non-negative number"
        return 1
    fi
}

#=================================================
# SPECIFIC SETTERS FOR TOML SHORT KEYS
#=================================================

set__admin_password() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=ADMIN_PASSWORD --value="$admin_password"
    
    # Need to restart the service for changes to take effect
    needs_restart=1
}

set__allowed_admin_ips() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=ALLOWED_ADMIN_IPS --value="$allowed_admin_ips"
    needs_restart=1
}

set__admin_path() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=ADMIN_PATH --value="$admin_path"
    needs_restart=1
}

set__root_redirect() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=ROOT_REDIRECT --value="$root_redirect"
    needs_restart=1
}

set__not_found_redirect() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=NOT_FOUND_REDIRECT --value="$not_found_redirect"
    needs_restart=1
}

set__session_window_min() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=SESSION_WINDOW_MIN --value="$session_window_min"
    needs_restart=1
}

set__user_cookie_max_days() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=USER_COOKIE_MAX_DAYS --value="$user_cookie_max_days"
    needs_restart=1
}

set__cookie_secure() {
    if [ "$cookie_secure" = "1" ]; then
        value="true"
    else
        value="false"
    fi
    ynh_write_var_in_file --file="$install_dir/.env" --key=COOKIE_SECURE --value="$value"
    needs_restart=1
}

set__rate_limit_window() {
    ynh_write_var_in_file --file="$install_dir/.env" --key=RATE_LIMIT_WINDOW --value="$rate_limit_window"
    needs_restart=1
}

#=================================================
# GENERIC FINALIZATION
#=================================================

# If any setting changed, restart the service
if [ "${needs_restart:-0}" -eq 1 ]; then
    ynh_systemctl --service="$app" --action=restart
fi
