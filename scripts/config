#!/bin/bash

source /usr/share/yunohost/helpers

#=================================================
# RETRIEVE ARGUMENTS
#=================================================

# Get the action (apply, show, etc.)
action=${1:-show}

#=================================================
# SPECIFIC GETTERS FOR TOML SHORT KEY
#=================================================

get__admin_password() {
    ynh_app_setting_get --app="$app" --key=admin_password
}

get__allowed_admin_ips() {
    ynh_app_setting_get --app="$app" --key=allowed_admin_ips
}

get__admin_path() {
    ynh_app_setting_get --app="$app" --key=admin_path
}

get__root_redirect() {
    ynh_app_setting_get --app="$app" --key=root_redirect
}

get__not_found_redirect() {
    ynh_app_setting_get --app="$app" --key=not_found_redirect
}

get__session_window_min() {
    ynh_app_setting_get --app="$app" --key=session_window_min
}

get__user_cookie_max_days() {
    ynh_app_setting_get --app="$app" --key=user_cookie_max_days
}

get__cookie_secure() {
    ynh_app_setting_get --app="$app" --key=cookie_secure
}

get__rate_limit_window() {
    ynh_app_setting_get --app="$app" --key=rate_limit_window
}

#=================================================
# SPECIFIC VALIDATORS FOR TOML SHORT KEYS
#=================================================

validate__admin_password() {
    # Check password is not empty
    if [ -z "$admin_password" ]; then
        echo "Password cannot be empty"
        return 1
    fi
}

validate__session_window_min() {
    # Must be a positive number
    if ! [[ "$session_window_min" =~ ^[0-9]+$ ]] || [ "$session_window_min" -lt 1 ]; then
        echo "Session window must be a positive number"
        return 1
    fi
}

validate__user_cookie_max_days() {
    # Must be a positive number
    if ! [[ "$user_cookie_max_days" =~ ^[0-9]+$ ]] || [ "$user_cookie_max_days" -lt 1 ]; then
        echo "Cookie lifetime must be a positive number"
        return 1
    fi
}

validate__rate_limit_window() {
    # Must be a non-negative number
    if ! [[ "$rate_limit_window" =~ ^[0-9]+$ ]]; then
        echo "Rate limit window must be a non-negative number"
        return 1
    fi
}

#=================================================
# SPECIFIC SETTERS FOR TOML SHORT KEYS
#=================================================

set__admin_password() {
    ynh_app_setting_set --app="$app" --key=admin_password --value="$admin_password"
    ynh_write_var_in_file --file="$install_dir/.env" --key=ADMIN_PASSWORD --value="$admin_password"
    needs_restart=1
}

set__allowed_admin_ips() {
    ynh_app_setting_set --app="$app" --key=allowed_admin_ips --value="$allowed_admin_ips"
    ynh_write_var_in_file --file="$install_dir/.env" --key=ALLOWED_ADMIN_IPS --value="$allowed_admin_ips"
    needs_restart=1
}

set__admin_path() {
    ynh_app_setting_set --app="$app" --key=admin_path --value="$admin_path"
    ynh_write_var_in_file --file="$install_dir/.env" --key=ADMIN_PATH --value="$admin_path"
    needs_restart=1
}

set__root_redirect() {
    ynh_app_setting_set --app="$app" --key=root_redirect --value="$root_redirect"
    ynh_write_var_in_file --file="$install_dir/.env" --key=ROOT_REDIRECT --value="$root_redirect"
    needs_restart=1
}

set__not_found_redirect() {
    ynh_app_setting_set --app="$app" --key=not_found_redirect --value="$not_found_redirect"
    ynh_write_var_in_file --file="$install_dir/.env" --key=NOT_FOUND_REDIRECT --value="$not_found_redirect"
    needs_restart=1
}

set__session_window_min() {
    ynh_app_setting_set --app="$app" --key=session_window_min --value="$session_window_min"
    ynh_write_var_in_file --file="$install_dir/.env" --key=SESSION_WINDOW_MIN --value="$session_window_min"
    needs_restart=1
}

set__user_cookie_max_days() {
    ynh_app_setting_set --app="$app" --key=user_cookie_max_days --value="$user_cookie_max_days"
    ynh_write_var_in_file --file="$install_dir/.env" --key=USER_COOKIE_MAX_DAYS --value="$user_cookie_max_days"
    needs_restart=1
}

set__cookie_secure() {
    ynh_app_setting_set --app="$app" --key=cookie_secure --value="$cookie_secure"
    if [ "$cookie_secure" = "1" ]; then
        value="true"
    else
        value="false"
    fi
    ynh_write_var_in_file --file="$install_dir/.env" --key=COOKIE_SECURE --value="$value"
    needs_restart=1
}

set__rate_limit_window() {
    ynh_app_setting_set --app="$app" --key=rate_limit_window --value="$rate_limit_window"
    ynh_write_var_in_file --file="$install_dir/.env" --key=RATE_LIMIT_WINDOW --value="$rate_limit_window"
    needs_restart=1
}

#=================================================
# GENERIC FINALIZATION
#=================================================

# If any setting changed, restart the service
if [ "${needs_restart:-0}" -eq 1 ]; then
    ynh_systemctl --service="$app" --action=restart
fi
