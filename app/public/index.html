<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Link Shortener Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #ffffff;
      margin-bottom: 30px;
      font-size: 2.5rem;
    }
    h2 {
      color: #ffffff;
      margin: 30px 0 15px;
      font-size: 1.5rem;
    }
    .auth-section {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      margin-bottom: 20px;
    }
    .content {
      display: none;
    }
    .content.active {
      display: block;
    }
    .card {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      margin-bottom: 20px;
    }
    input, textarea, button {
      font-family: inherit;
      font-size: 14px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #404040;
      border-radius: 6px;
      margin-bottom: 10px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #0071e3;
    }
    button {
      background: #0071e3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover {
      background: #0077ed;
    }
    button.danger {
      background: #ff3b30;
    }
    button.danger:hover {
      background: #ff453a;
    }
    button.secondary {
      background: #4a4a4a;
    }
    button.secondary:hover {
      background: #5a5a5a;
    }
    button.success {
      background: #34c759;
    }
    button.success:hover {
      background: #30d158;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #404040;
    }
    th {
      background: #1a1a1a;
      font-weight: 600;
      color: #ffffff;
    }
    tr:hover {
      background: #333333;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .status.success {
      background: #1a4d2e;
      color: #4ade80;
    }
    .status.error {
      background: #4d1a1a;
      color: #f87171;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px;
      background: #2a2a2a;
      color: #e0e0e0;
    }
    .tab.active {
      background: #0071e3;
      color: white;
    }
    .tab:hover:not(.active) {
      background: #333333;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .truncate {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <h1 style="margin: 0;">ðŸ”— Link Shortener Admin</h1>
      <button id="logoutBtn" onclick="logout()" class="secondary" style="display: none;">Logout</button>
    </div>
    
    <!-- Authentication -->
    <div id="authSection" class="auth-section">
      <h2>Login</h2>
      <input type="password" id="password" placeholder="Admin Password" onkeypress="if(event.key==='Enter')authenticate()">
      <button onclick="authenticate()">Login</button>
      <div id="authStatus"></div>
      <div style="margin-top: 10px; text-align: center;">
        <a href="#" onclick="localStorage.removeItem('adminPassword'); location.reload(); return false;" style="color: #888; font-size: 12px; text-decoration: none;">Clear saved password</a>
      </div>
    </div>

    <!-- Main Content -->
    <div id="content" class="content">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('links')">Links</div>
        <div class="tab" onclick="switchTab('hits')">Recent Hits</div>
        <div class="tab" onclick="switchTab('blacklist')">IP Blacklist</div>
        <div class="tab" onclick="switchTab('tokens')">API Tokens</div>
        <div class="tab" onclick="switchTab('export')">Export</div>
      </div>

      <!-- Links Tab -->
      <div id="linksTab" class="tab-content">
        <div class="card">
          <h2>Add/Update Link</h2>
          <input type="text" id="slug" placeholder="Slug (e.g., 'example')">
          <input type="text" id="destination" placeholder="Destination URL">
          <button onclick="addLink()">Save Link</button>
          <div id="linkStatus"></div>
        </div>

        <div class="card">
          <h2>Existing Links</h2>
          <table id="linksTable">
            <thead>
              <tr>
                <th>Slug</th>
                <th>Destination</th>
                <th>Hits</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Hits Tab -->
      <div id="hitsTab" class="tab-content" style="display: none;">
        <div class="card">
          <h2>Recent Hits</h2>
          <button onclick="loadHits()">Refresh</button>
          <table id="hitsTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Slug</th>
                <th>IP</th>
                <th>Browser</th>
                <th>Referer</th>
                <th>Params</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Blacklist Tab -->
      <div id="blacklistTab" class="tab-content" style="display: none;">
        <div class="card">
          <h2>Add IP to Blacklist</h2>
          <div class="form-row">
            <input type="text" id="blacklistIP" placeholder="IP Address">
            <input type="text" id="blacklistReason" placeholder="Reason (optional)">
          </div>
          <button onclick="addToBlacklist()">Add to Blacklist</button>
          <div id="blacklistStatus"></div>
        </div>

        <div class="card">
          <h2>Blacklisted IPs</h2>
          <table id="blacklistTable">
            <thead>
              <tr>
                <th>IP</th>
                <th>Reason</th>
                <th>Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- API Tokens Tab -->
      <div id="tokensTab" class="tab-content" style="display:none;">
        <div class="card">
          <h2>Create API Token</h2>
          <input type="text" id="tokenName" placeholder="Token name (e.g., automation-script)">
          <div style="margin: 12px 0; display: flex; align-items: center; gap: 20px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="scope_links" style="margin: 0; cursor: pointer;"> Links
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="scope_hits" style="margin: 0; cursor: pointer;"> Hits
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="scope_blacklist" style="margin: 0; cursor: pointer;"> Blacklist
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="scope_export" style="margin: 0; cursor: pointer;"> Export
            </label>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="createToken()">Generate Token</button>
            <button onclick="selectAllScopes()" class="secondary">Select All</button>
          </div>
          <div id="tokenStatus"></div>
        </div>
        <div class="card">
          <h2>Existing Tokens</h2>
          <table id="tokensTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Scopes</th>
                <th>Last Used</th>
                <th>Token</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Export Tab -->
      <div id="exportTab" class="tab-content" style="display: none;">
        <div class="card">
          <h2>Export Data</h2>
          <button onclick="exportCSV()">Download Hits as CSV</button>
          <button onclick="downloadDB()" class="secondary">Download Database</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let password = '';

    // Check for saved password on load
    window.addEventListener('DOMContentLoaded', () => {
      const savedPassword = localStorage.getItem('adminPassword');
      if (savedPassword) {
        password = savedPassword;
        // Show a loading indicator
        const authSection = document.getElementById('authSection');
        const originalContent = authSection.innerHTML;
        authSection.innerHTML = '<p style="text-align: center; color: #888;">Authenticating...</p>';
        
        // Try to authenticate with saved password
        fetch('/admin/links', {
          headers: { 'Authorization': `Bearer ${password}` }
        })
        .then(r => {
          if (r.ok) {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('content').classList.add('active');
            document.getElementById('logoutBtn').style.display = 'block';
            loadLinks();
          } else {
            // Invalid saved password, clear it and restore login form
            localStorage.removeItem('adminPassword');
            password = '';
            authSection.innerHTML = originalContent;
            showStatus('authStatus', 'Saved password expired - please login again', 'error');
          }
        })
        .catch(() => {
          localStorage.removeItem('adminPassword');
          password = '';
          authSection.innerHTML = originalContent;
          showStatus('authStatus', 'Connection failed - please try again', 'error');
        });
      }
    });

    function authenticate() {
      // Clear any saved password first to ensure fresh login
      localStorage.removeItem('adminPassword');
      
      password = document.getElementById('password').value;
      fetch('/admin/links', {
        headers: { 'Authorization': `Bearer ${password}` }
      })
      .then(r => {
        if (r.ok) {
          // Save password to localStorage
          localStorage.setItem('adminPassword', password);
          document.getElementById('authSection').style.display = 'none';
          document.getElementById('content').classList.add('active');
          document.getElementById('logoutBtn').style.display = 'block';
          loadLinks();
        } else {
          showStatus('authStatus', 'Invalid password', 'error');
        }
      })
      .catch(e => showStatus('authStatus', 'Authentication failed', 'error'));
    }

    function logout() {
      localStorage.removeItem('adminPassword');
      password = '';
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('content').classList.remove('active');
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('password').value = '';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      
      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').style.display = 'block';
      
      if (tab === 'links') loadLinks();
      if (tab === 'hits') loadHits();
      if (tab === 'blacklist') loadBlacklist();
      if (tab === 'tokens') loadTokens();
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 3000);
    }

    async function addLink() {
      const slug = document.getElementById('slug').value;
      const destination = document.getElementById('destination').value;
      
      if (!slug || !destination) {
        showStatus('linkStatus', 'Please fill all fields', 'error');
        return;
      }

      const res = await fetch('/admin/links', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${password}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ slug, destination })
      });

      if (res.ok) {
        showStatus('linkStatus', 'Link saved successfully', 'success');
        document.getElementById('slug').value = '';
        document.getElementById('destination').value = '';
        loadLinks();
      } else {
        showStatus('linkStatus', 'Failed to save link', 'error');
      }
    }

    function testLink(slug) {
      const url = `${window.location.origin}/l/${slug}`;
      window.open(url, '_blank');
    }

    async function deleteLink(slug) {
      if (!confirm(`Delete link "${slug}"?`)) return;

      const res = await fetch(`/admin/links/${slug}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${password}` }
      });

      if (res.ok) {
        loadLinks();
      } else {
        alert('Failed to delete link');
      }
    }

    async function loadLinks() {
      const res = await fetch('/admin/links', {
        headers: { 'Authorization': `Bearer ${password}` }
      });
      const data = await res.json();
      
      const tbody = document.querySelector('#linksTable tbody');
      tbody.innerHTML = data.links.map(link => `
        <tr>
          <td><strong>${link.slug}</strong></td>
          <td class="truncate" title="${link.destination}">${link.destination}</td>
          <td>${link.hits}</td>
          <td class="actions">
            <button onclick="testLink('${link.slug}')" class="success">Test</button>
            <button onclick="deleteLink('${link.slug}')" class="danger">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function loadHits() {
      const res = await fetch('/admin/hits?limit=100', {
        headers: { 'Authorization': `Bearer ${password}` }
      });
      const data = await res.json();
      
      const tbody = document.querySelector('#hitsTable tbody');
      tbody.innerHTML = data.hits.map(hit => `
        <tr>
          <td>${new Date(hit.timestamp).toLocaleString()}</td>
          <td>${hit.type}</td>
          <td>${hit.slug}</td>
          <td>${hit.ip}</td>
          <td>${hit.browser}</td>
          <td class="truncate" title="${hit.referer}">${hit.referer}</td>
          <td class="truncate" title="${hit.query_params || ''}">${hit.query_params || '-'}</td>
        </tr>
      `).join('');
    }

    async function addToBlacklist() {
      const ip = document.getElementById('blacklistIP').value;
      const reason = document.getElementById('blacklistReason').value;
      
      if (!ip) {
        showStatus('blacklistStatus', 'Please enter an IP address', 'error');
        return;
      }

      const res = await fetch('/admin/blacklist', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${password}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ip, reason })
      });

      if (res.ok) {
        showStatus('blacklistStatus', 'IP added to blacklist', 'success');
        document.getElementById('blacklistIP').value = '';
        document.getElementById('blacklistReason').value = '';
        loadBlacklist();
      } else {
        showStatus('blacklistStatus', 'Failed to add IP', 'error');
      }
    }

    async function removeFromBlacklist(ip) {
      if (!confirm(`Remove ${ip} from blacklist?`)) return;

      const res = await fetch(`/admin/blacklist/${encodeURIComponent(ip)}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${password}` }
      });

      if (res.ok) {
        loadBlacklist();
      } else {
        alert('Failed to remove IP');
      }
    }

    async function loadBlacklist() {
      const res = await fetch('/admin/blacklist', {
        headers: { 'Authorization': `Bearer ${password}` }
      });
      const data = await res.json();
      
      const tbody = document.querySelector('#blacklistTable tbody');
      tbody.innerHTML = data.blacklist.map(item => `
        <tr>
          <td><strong>${item.ip}</strong></td>
          <td>${item.reason || '-'}</td>
          <td>${new Date(item.created_at * 1000).toLocaleString()}</td>
          <td class="actions">
            <button onclick="removeFromBlacklist('${item.ip}')" class="danger">Remove</button>
          </td>
        </tr>
      `).join('');
    }

    function selectAllScopes() {
      document.getElementById('scope_links').checked = true;
      document.getElementById('scope_hits').checked = true;
      document.getElementById('scope_blacklist').checked = true;
      document.getElementById('scope_export').checked = true;
    }

    function copyToken(token) {
      navigator.clipboard.writeText(token).then(() => {
        alert('Token copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy token');
      });
    }

    async function loadTokens() {
      const res = await fetch('/admin/tokens', { headers: { 'Authorization': `Bearer ${password}` }});
      if (!res.ok) { showStatus('tokenStatus','Failed to load tokens','error'); return; }
      const data = await res.json();
      const tbody = document.querySelector('#tokensTable tbody');
      tbody.innerHTML = data.tokens.map(t => `
        <tr>
          <td>${t.id}</td>
          <td>${t.name}</td>
          <td>${t.scopes}</td>
          <td>${t.last_used_at ? new Date(t.last_used_at*1000).toLocaleString() : '-'}</td>
          <td class="truncate" title="${t.token || ''}">${t.token || '(hidden)'}</td>
          <td class="actions">
            <button onclick="copyToken('${t.token}')" class="success">Copy</button>
            <button class="danger" onclick="revokeToken(${t.id})">Revoke</button>
          </td>
        </tr>
      `).join('');
    }

    async function createToken() {
      const name = document.getElementById('tokenName').value;
      const scopes = [];
      if (document.getElementById('scope_links').checked) scopes.push('links');
      if (document.getElementById('scope_hits').checked) scopes.push('hits');
      if (document.getElementById('scope_blacklist').checked) scopes.push('blacklist');
      if (document.getElementById('scope_export').checked) scopes.push('export');
      if (!name || scopes.length === 0) { showStatus('tokenStatus','Name and at least one scope required','error'); return; }
      const res = await fetch('/admin/tokens', {
        method: 'POST', headers: { 'Authorization': `Bearer ${password}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, scopes })
      });
      if (!res.ok) { showStatus('tokenStatus','Failed to create token','error'); return; }
      const data = await res.json();
      const statusMsg = `Token created! <button onclick="copyToken('${data.token}')" style="margin-left: 10px;">Copy Token</button>`;
      showStatus('tokenStatus', statusMsg, 'success');
      document.getElementById('tokenName').value = '';
      selectAllScopes(); // Reset to all selected for next token
      loadTokens();
    }

    async function revokeToken(id) {
      if (!confirm('Revoke this token?')) return;
      const res = await fetch(`/admin/tokens/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${password}` }});
      if (!res.ok) { alert('Failed to revoke token'); return; }
      loadTokens();
    }

    async function exportCSV() {
      try {
        const res = await fetch('/admin/export/csv', {
          headers: { 'Authorization': `Bearer ${password}` }
        });
        if (!res.ok) {
          alert('Failed to export CSV');
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `hits-${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (e) {
        alert('Failed to export CSV');
      }
    }

    async function downloadDB() {
      try {
        const res = await fetch('/admin/download/db', {
          headers: { 'Authorization': `Bearer ${password}` }
        });
        if (!res.ok) {
          alert('Failed to download database');
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'app.db';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (e) {
        alert('Failed to download database');
      }
    }
  </script>
</body>
</html>
